/************ 設定 ************/
const SHEET_MASTER = '園児マスター';
const SHEET_BELONGS = '所属_年度';
const SHEET_INPUT_PREFIX = '入力_月次';
const SHEET_LOG = 'ログ_縦持ち';

const WEBAPP_URL_PROP = 'WEBAPP_URL';
const LOG_UPDATED_AT_PROP = 'LOG_UPDATED_AT';

// 同一実行内キャッシュ用の変数
let _belongsCache = null;

/************ 身体発育曲線 基準データ（パーセンタイル値） ************/
// 出典: 厚生労働省 令和5年度「乳幼児身体発育調査」
// 配列インデックス = 月齢（0〜72）、単位: 身長=cm, 体重=kg
const GROWTH_REF = {
  male: {
    height: {
      p3:  [45.24,49.21,51.26,54.94,57.99,60.23,61.88,63.22,64.39,65.46,66.47,67.45,68.40,71.59,71.59,71.59,71.59,71.59,76.74,76.74,76.74,76.74,76.74,76.74,80.47,80.47,80.47,80.47,80.47,80.47,84.34,84.34,84.34,84.34,84.34,84.34,87.78,87.78,87.78,87.78,87.78,87.78,91.02,91.02,91.02,91.02,91.02,91.02,94.17,94.17,94.17,94.17,94.17,94.17,97.28,97.28,97.28,97.28,97.28,97.28,100.35,100.35,100.35,100.35,100.35,100.35,103.34,103.34,103.34,103.34,103.34,103.34,106.27],
      p50: [49.42,53.44,55.46,59.16,62.27,64.55,66.25,67.63,68.84,69.96,71.03,72.07,73.08,76.51,76.51,76.51,76.51,76.51,82.11,82.11,82.11,82.11,82.11,82.11,86.26,86.26,86.26,86.26,86.26,86.26,90.50,90.50,90.50,90.50,90.50,90.50,94.28,94.28,94.28,94.28,94.28,94.28,97.84,97.84,97.84,97.84,97.84,97.84,101.29,101.29,101.29,101.29,101.29,101.29,104.69,104.69,104.69,104.69,104.69,104.69,108.04,108.04,108.04,108.04,108.04,108.04,111.31,111.31,111.31,111.31,111.31,111.31,114.50],
      p97: [52.72,56.84,58.90,62.73,65.95,68.33,70.11,71.56,72.84,74.04,75.19,76.30,77.40,81.12,81.12,81.12,81.12,81.12,87.23,87.23,87.23,87.23,87.23,87.23,91.88,91.88,91.88,91.88,91.88,91.88,96.57,96.57,96.57,96.57,96.57,96.57,100.77,100.77,100.77,100.77,100.77,100.77,104.72,104.72,104.72,104.72,104.72,104.72,108.56,108.56,108.56,108.56,108.56,108.56,112.33,112.33,112.33,112.33,112.33,112.33,116.04,116.04,116.04,116.04,116.04,116.04,119.67,119.67,119.67,119.67,119.67,119.67,123.21]
    },
    weight: {
      p3:  [2.32,3.23,3.76,4.59,5.22,5.71,6.09,6.40,6.64,6.85,7.03,7.20,7.37,7.94,7.94,7.94,7.94,7.94,8.93,8.93,8.93,8.93,8.93,8.93,9.85,9.85,9.85,9.85,9.85,9.85,10.66,10.66,10.66,10.66,10.66,10.66,11.38,11.38,11.38,11.38,11.38,11.38,12.10,12.10,12.10,12.10,12.10,12.10,12.84,12.84,12.84,12.84,12.84,12.84,13.64,13.64,13.64,13.64,13.64,13.64,14.49,14.49,14.49,14.49,14.49,14.49,15.37,15.37,15.37,15.37,15.37,15.37,16.28],
      p50: [3.06,4.15,4.80,5.80,6.55,7.12,7.56,7.91,8.19,8.42,8.63,8.82,9.00,9.66,9.66,9.66,9.66,9.66,10.84,10.84,10.84,10.84,10.84,10.84,11.95,11.95,11.95,11.95,11.95,11.95,12.94,12.94,12.94,12.94,12.94,12.94,13.83,13.83,13.83,13.83,13.83,13.83,14.72,14.72,14.72,14.72,14.72,14.72,15.64,15.64,15.64,15.64,15.64,15.64,16.62,16.62,16.62,16.62,16.62,16.62,17.66,17.66,17.66,17.66,17.66,17.66,18.74,18.74,18.74,18.74,18.74,18.74,19.85],
      p97: [3.81,5.04,5.80,6.97,7.84,8.50,9.01,9.41,9.73,10.00,10.23,10.45,10.66,11.43,11.43,11.43,11.43,11.43,12.84,12.84,12.84,12.84,12.84,12.84,14.22,14.22,14.22,14.22,14.22,14.22,15.50,15.50,15.50,15.50,15.50,15.50,16.70,16.70,16.70,16.70,16.70,16.70,17.94,17.94,17.94,17.94,17.94,17.94,19.27,19.27,19.27,19.27,19.27,19.27,20.74,20.74,20.74,20.74,20.74,20.74,22.35,22.35,22.35,22.35,22.35,22.35,24.12,24.12,24.12,24.12,24.12,24.12,26.04]
    }
  },
  female: {
    height: {
      p3:  [44.47,48.54,50.54,53.87,56.47,58.60,60.37,61.87,63.15,64.27,65.28,66.21,67.13,70.34,70.34,70.34,70.34,70.34,75.65,75.65,75.65,75.65,75.65,75.65,79.46,79.46,79.46,79.46,79.46,79.46,83.44,83.44,83.44,83.44,83.44,83.44,86.78,86.78,86.78,86.78,86.78,86.78,89.93,89.93,89.93,89.93,89.93,89.93,93.21,93.21,93.21,93.21,93.21,93.21,96.45,96.45,96.45,96.45,96.45,96.45,99.57,99.57,99.57,99.57,99.57,99.57,102.54,102.54,102.54,102.54,102.54,102.54,105.39],
      p50: [48.77,52.43,54.49,57.92,60.62,62.84,64.70,66.27,67.63,68.82,69.88,70.89,71.86,75.30,75.30,75.30,75.30,75.30,81.02,81.02,81.02,81.02,81.02,81.02,85.22,85.22,85.22,85.22,85.22,85.22,89.56,89.56,89.56,89.56,89.56,89.56,93.25,93.25,93.25,93.25,93.25,93.25,96.75,96.75,96.75,96.75,96.75,96.75,100.39,100.39,100.39,100.39,100.39,100.39,104.01,104.01,104.01,104.01,104.01,104.01,107.50,107.50,107.50,107.50,107.50,107.50,110.85,110.85,110.85,110.85,110.85,110.85,114.05],
      p97: [52.00,55.75,57.90,61.49,64.32,66.65,68.61,70.29,71.73,73.01,74.15,75.23,76.29,80.00,80.00,80.00,80.00,80.00,86.19,86.19,86.19,86.19,86.19,86.19,90.83,90.83,90.83,90.83,90.83,90.83,95.61,95.61,95.61,95.61,95.61,95.61,99.70,99.70,99.70,99.70,99.70,99.70,103.62,103.62,103.62,103.62,103.62,103.62,107.71,107.71,107.71,107.71,107.71,107.71,111.79,111.79,111.79,111.79,111.79,111.79,115.74,115.74,115.74,115.74,115.74,115.74,119.54,119.54,119.54,119.54,119.54,119.54,123.19]
    },
    weight: {
      p3:  [2.22,3.05,3.51,4.27,4.90,5.40,5.79,6.10,6.34,6.54,6.70,6.85,6.99,7.49,7.49,7.49,7.49,7.49,8.50,8.50,8.50,8.50,8.50,8.50,9.52,9.52,9.52,9.52,9.52,9.52,10.46,10.46,10.46,10.46,10.46,10.46,11.19,11.19,11.19,11.19,11.19,11.19,11.82,11.82,11.82,11.82,11.82,11.82,12.51,12.51,12.51,12.51,12.51,12.51,13.24,13.24,13.24,13.24,13.24,13.24,13.98,13.98,13.98,13.98,13.98,13.98,14.75,14.75,14.75,14.75,14.75,14.75,15.52],
      p50: [2.95,3.91,4.44,5.33,6.06,6.64,7.10,7.47,7.75,7.99,8.19,8.36,8.53,9.12,9.12,9.12,9.12,9.12,10.30,10.30,10.30,10.30,10.30,10.30,11.50,11.50,11.50,11.50,11.50,11.50,12.60,12.60,12.60,12.60,12.60,12.60,13.48,13.48,13.48,13.48,13.48,13.48,14.28,14.28,14.28,14.28,14.28,14.28,15.21,15.21,15.21,15.21,15.21,15.21,16.21,16.21,16.21,16.21,16.21,16.21,17.24,17.24,17.24,17.24,17.24,17.24,18.34,18.34,18.34,18.34,18.34,18.34,19.53],
      p97: [3.66,4.74,5.36,6.39,7.24,7.92,8.46,8.90,9.25,9.54,9.79,10.01,10.22,10.97,10.97,10.97,10.97,10.97,12.43,12.43,12.43,12.43,12.43,12.43,13.92,13.92,13.92,13.92,13.92,13.92,15.33,15.33,15.33,15.33,15.33,15.33,16.49,16.49,16.49,16.49,16.49,16.49,17.65,17.65,17.65,17.65,17.65,17.65,19.10,19.10,19.10,19.10,19.10,19.10,20.71,20.71,20.71,20.71,20.71,20.71,22.45,22.45,22.45,22.45,22.45,22.45,24.12,24.12,24.12,24.12,24.12,24.12,27.01]
    }
  }
};

/************ Webアプリ（初期表示） ************/
function doGet(e) {
  const t = e?.parameter?.t;
  if (!t) return htmlMessage_('URLが正しくありません');

  const data = getChildData_(t, null);
  if (!data) return htmlMessage_('データが見つかりません');

  const tpl = HtmlService.createTemplateFromFile('viewer');
  tpl.token = t;
  tpl.initialDataJson = JSON.stringify(data);

  return tpl.evaluate()
    .setTitle('成長記録')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/************ データ切り替え・更新用関数 ************/
function getDataForFy(token, fy) {
  return getChildData_(token, fy ? Number(fy) : null);
}

/************ ① トークン発行＆URL作成 ************/
function ensureTokensAndUrls() {
  const ss = getSS_();
  const sh = ss.getSheetByName(SHEET_MASTER);
  if (!sh) throw new Error('園児マスターが見つかりません');

  let webappUrl = PropertiesService.getScriptProperties().getProperty(WEBAPP_URL_PROP);
  if (!webappUrl) {
    const u = ScriptApp.getService().getUrl();
    if (u) {
      webappUrl = u;
      PropertiesService.getScriptProperties().setProperty(WEBAPP_URL_PROP, webappUrl);
    }
  }

  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();
  if (lastRow < 2) return;

  const data = sh.getRange(1, 1, lastRow, lastCol).getValues();
  const header = data[0];
  const idxChild = mustIndex_(header, 'child_id');
  const idxToken = mustIndex_(header, 'token');
  const idxUrl   = mustIndex_(header, 'parent_url');
  const idxQr    = header.indexOf('QRコードURL');
  const idxStatus = header.indexOf('在園・卒園');

  let successCount = 0;
  for (let r = 1; r < data.length; r++) {
    const rowNum = r + 1;
    const cid = String(data[r][idxChild] || '').trim();
    if (!cid || (idxStatus !== -1 && data[r][idxStatus] === '卒園')) continue;

    const hasToken = !!String(data[r][idxToken] || '').trim();
    const hasUrl   = !!String(data[r][idxUrl] || '').trim();
    const hasQr    = (idxQr === -1) || !!String(data[r][idxQr] || '').trim();

    if (hasToken && hasUrl && hasQr) continue;

    let rowToken = data[r][idxToken] || generateToken(40);
    let rowUrl = `${webappUrl}?t=${encodeURIComponent(rowToken)}`;
    let rowQr = (idxQr !== -1) ? `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(rowUrl)}` : null;

    try {
      if (!hasToken) sh.getRange(rowNum, idxToken + 1).setValue(rowToken);
      sh.getRange(rowNum, idxUrl + 1).setValue(rowUrl);
      if (idxQr !== -1 && !hasQr) sh.getRange(rowNum, idxQr + 1).setValue(rowQr);
      successCount++;
    } catch(e) { console.log(e); }
  }
  SpreadsheetApp.getUi().alert(successCount === 0 ? '更新不要でした。' : successCount + ' 名更新しました。');
}

/************ ② 入力 → 縦持ちログ更新 ************/
function rebuildLogFromInput() {
  const ss = getSS_();
  const inputSheets = ss.getSheets().filter(s => s.getName().startsWith(SHEET_INPUT_PREFIX));
  const activeMasterIds = readActiveMasterIdSet_(); 
  const out = [];

  inputSheets.forEach(sh => {
    const values = sh.getDataRange().getValues();
    if (values.length < 2) return;
    const headerRowIndex = findHeaderRowIndex_(values);
    if (headerRowIndex < 0) return;
    const header = values[headerRowIndex];
    const idxChild = header.indexOf('child_id');
    const months = parseMonthColumns_(header);

    for (let r = headerRowIndex + 1; r < values.length; r++) {
      const cid = normalizeId_(values[r][idxChild]);
      if (!cid || !activeMasterIds.has(cid)) continue;
      months.forEach(m => {
        const h = toNumberOrBlank_(values[r][m.hCol]);
        const w = toNumberOrBlank_(values[r][m.wCol]);
        if ((h !== '' || w !== '') && !(h === 0 && w === 0)) {
          out.push([cid, String(m.ym), h, w]);
        }
      });
    }
  });

  out.sort((a, b) => {
    if (a[0] !== b[0]) return a[0].localeCompare(b[0], undefined, {numeric: true});
    return a[1].localeCompare(b[1]);
  });

  let logSh = ss.getSheetByName(SHEET_LOG);
  if (!logSh) logSh = ss.insertSheet(SHEET_LOG);
  logSh.clearContents();
  const finalOut = [['child_id','ym','height','weight'], ...out];
  logSh.getRange(1, 1, finalOut.length, finalOut[0].length).setValues(finalOut);
  if (finalOut.length > 1) logSh.getRange(2, 2, finalOut.length - 1, 1).setNumberFormat('@');

  PropertiesService.getScriptProperties().setProperty(LOG_UPDATED_AT_PROP, new Date().toISOString());
  SpreadsheetApp.getUi().alert('縦持ちログを更新しました。');
}

/************ 高速データ取得ロジック（ChatGPT改善反映版） ************/
function getChildData_(token, targetFy) {
  const ss = getSS_();
  const masterSh = ss.getSheetByName(SHEET_MASTER);
  const logSh = ss.getSheetByName(SHEET_LOG);
  const belongsSh = ss.getSheetByName(SHEET_BELONGS);
  if (!masterSh || !logSh) return null;

  const masterValues = masterSh.getDataRange().getValues();
  const m = masterFindByToken_(masterValues, token);
  if (!m) return null;

  const targetCid = normalizeId_(m.child_id);
  const seriesAll = [];

  const lastRowLog = logSh.getLastRow();
  let firstMatch = null;
  if (lastRowLog > 1) {
    firstMatch = logSh.getRange(2, 1, lastRowLog - 1, 1)
      .createTextFinder(targetCid)
      .matchEntireCell(true)
      .findNext();
  }

  if (firstMatch) {
    const startRow = firstMatch.getRow();
    const MAX_ROWS_PER_CHILD = 120;
    const rowsToRead = Math.min(MAX_ROWS_PER_CHILD, (lastRowLog - startRow + 1));
    const numCols = 4;

    const data = logSh.getRange(startRow, 1, rowsToRead, numCols).getValues();
    
    for (let row of data) {
      if (normalizeId_(row[0]) !== targetCid) break;
      const ym = ymToYYYYMM_(row[1]);
      if (/^\d{4}-\d{2}$/.test(ym)) {
        seriesAll.push({ ym, h: toNumberOrNull_(row[2]), w: toNumberOrNull_(row[3]) });
      }
    }
  }
  seriesAll.sort((a,b) => a.ym.localeCompare(b.ym));

  const fyOfYm = (ymStr) => {
    const [y,m] = String(ymStr).split('-').map(Number);
    return (m >= 4) ? y : (y - 1);
  };

  const fySet = new Set(seriesAll.map(r => fyOfYm(r.ym)));
  const fyList = Array.from(fySet).sort((a,b)=>a-b);
  const selectedFy = (targetFy && fySet.has(targetFy)) ? targetFy : (fyList.length ? fyList[fyList.length - 1] : null);

  let displayClass = "クラス不明";
  if (belongsSh && selectedFy) {
    // ★改善：同一実行内キャッシュを利用して読み込みを効率化
    const bVals = getBelongsValues_(belongsSh);
    const head = bVals[0];
    const ci = head.indexOf('child_id'), fi = head.indexOf('fy'), ni = head.indexOf('class');
    const match = bVals.find(r => normalizeId_(r[ci]) === targetCid && Number(r[fi]) === selectedFy);
    if (match) displayClass = match[ni];
  }

  const seriesFy = (selectedFy == null) ? [] : seriesAll.filter(r => fyOfYm(r.ym) === selectedFy);

  // 身体発育曲線データを付加（birthday・gender が有効な場合のみ）
  // 年度全期間（4月〜3月）の基準帯を生成し、実測データをマージ
  let series;
  if (m.birthday && m.gender && selectedFy != null) {
    const dataMap = {};
    seriesFy.forEach(entry => { dataMap[entry.ym] = entry; });

    series = [];
    for (let mi = 0; mi < 12; mi++) {
      const month = ((mi + 4 - 1) % 12) + 1; // 4,5,...,12,1,2,3
      const year = month >= 4 ? selectedFy : selectedFy + 1;
      const ym = `${year}-${String(month).padStart(2, '0')}`;
      const existing = dataMap[ym];
      const entry = existing || { ym, h: null, w: null };
      const age = calcMonthAge_(m.birthday, ym);
      entry.monthAge = age;
      const hRef = lookupPercentile_(m.gender, 'height', age);
      if (hRef) { entry.p3_h = hRef.p3; entry.p50_h = hRef.p50; entry.p97_h = hRef.p97; }
      const wRef = lookupPercentile_(m.gender, 'weight', age);
      if (wRef) { entry.p3_w = wRef.p3; entry.p50_w = wRef.p50; entry.p97_w = wRef.p97; }
      series.push(entry);
    }
  } else {
    series = seriesFy;
  }

  // latest/prev は実測データがあるエントリのみから取得
  const measured = series.filter(r => r.h != null || r.w != null);
  const latest = measured.length ? measured[measured.length - 1] : null;
  const prev = measured.length > 1 ? measured[measured.length - 2] : null;

  // ★改善：!= null 判定により、値が 0 の場合でも正しく計算されるように修正
  const diff = {
    dh: (latest?.h != null && prev?.h != null) ? +(latest.h - prev.h).toFixed(1) : null,
    dw: (latest?.w != null && prev?.w != null) ? +(latest.w - prev.w).toFixed(1) : null
  };

  const iso = PropertiesService.getScriptProperties().getProperty(LOG_UPDATED_AT_PROP);
  const updatedAt = iso ? Utilities.formatDate(new Date(iso), 'JST', 'yyyy/MM/dd HH:mm') : '—';

  return {
    childName: m.name,
    childClass: displayClass,
    gender: m.gender || null,
    series: series,
    latest: latest,
    diff: diff,
    updatedAt: updatedAt,
    fyList: fyList,
    selectedFy: selectedFy,
    siblings: m.siblings,
    appUrl: ScriptApp.getService().getUrl()
  };
}

/** 所属シートの読み込みをキャッシュ化するヘルパー */
function getBelongsValues_(belongsSh) {
  if (_belongsCache) return _belongsCache;
  _belongsCache = belongsSh.getDataRange().getValues();
  return _belongsCache;
}

/************ 共通ヘルパー ************/
function masterFindByToken_(values, token) {
  const head = values[0];
  const ci = head.indexOf('child_id'), ni = head.indexOf('name'), ti = head.indexOf('token');
  const bi = head.indexOf('birthday'), gi = head.indexOf('gender');
  for (let i=1; i<values.length; i++) {
    if (values[i][ti] === token) {
      const sibs = [];
      const sn1 = head.indexOf('sibling_name_1'), st1 = head.indexOf('sibling_token_1');
      const sn2 = head.indexOf('sibling_name_2'), st2 = head.indexOf('sibling_token_2');
      if (st1 !== -1 && values[i][st1]) sibs.push({ name: String((sn1 !== -1 && values[i][sn1]) || '兄弟1'), token: String(values[i][st1]) });
      if (st2 !== -1 && values[i][st2]) sibs.push({ name: String((sn2 !== -1 && values[i][sn2]) || '兄弟2'), token: String(values[i][st2]) });

      let birthday = null;
      if (bi !== -1 && values[i][bi]) {
        const bv = values[i][bi];
        if (bv instanceof Date) {
          birthday = `${bv.getFullYear()}-${String(bv.getMonth()+1).padStart(2,'0')}-${String(bv.getDate()).padStart(2,'0')}`;
        } else {
          const s = String(bv).trim();
          if (/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/.test(s)) birthday = s.replace(/\//g, '-');
        }
      }

      let gender = null;
      if (gi !== -1) {
        const gv = String(values[i][gi] || '').trim();
        if (gv === '男') gender = 'male';
        else if (gv === '女') gender = 'female';
      }

      return {
        child_id: normalizeId_(values[i][ci]),
        name: String(values[i][ni] || '').replace(/[\s\u200B-\u200D\uFEFF]+/g,''),
        siblings: sibs,
        birthday: birthday,
        gender: gender
      };
    }
  }
  return null;
}

/** 月齢計算: 生年月日("YYYY-MM-DD")と測定月("YYYY-MM")から月齢を返す */
function calcMonthAge_(birthdayStr, ym) {
  const [by, bm] = birthdayStr.split('-').map(Number);
  const [y, m] = ym.split('-').map(Number);
  return (y - by) * 12 + (m - bm);
}

/** パーセンタイル値検索: 性別・指標・月齢から {p3, p50, p97} を返す（範囲外はnull） */
function lookupPercentile_(gender, metric, monthAge) {
  if (monthAge < 0 || monthAge > 72) return null;
  const ref = GROWTH_REF[gender]?.[metric];
  if (!ref || monthAge >= ref.p50.length) return null;
  return { p3: ref.p3[monthAge], p50: ref.p50[monthAge], p97: ref.p97[monthAge] };
}

function getSS_() { return SpreadsheetApp.getActiveSpreadsheet(); }
function normalizeId_(v) { return String(v || '').trim().replace(/^0+/, '') || '0'; }
function ymToYYYYMM_(v) {
  if (v instanceof Date) return `${v.getFullYear()}-${String(v.getMonth() + 1).padStart(2, '0')}`;
  const s = String(v).trim();
  const m = s.match(/^(\d{4})-(\d{1,2})$/);
  return m ? `${m[1]}-${m[2].padStart(2,'0')}` : s;
}
function mustIndex_(h, n){ const i = h.indexOf(n); if (i < 0) throw new Error(`「${n}」列なし`); return i; }
function generateToken(l){ const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; return [...Array(l)].map(()=>c[Math.floor(Math.random()*c.length)]).join(''); }
function toNumberOrNull_(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }
function toNumberOrBlank_(v){ const n = Number(v); return Number.isFinite(n) ? n : ''; }
function htmlMessage_(m){ return HtmlService.createHtmlOutput(`<meta name="viewport" content="width=device-width, initial-scale=1"><div style="padding:16px">${m}</div>`); }
function findHeaderRowIndex_(v) {
  for (let i = 0; i < Math.min(v.length, 20); i++) if (v[i].includes('child_id')) return i;
  return -1;
}
function parseMonthColumns_(h) {
  const map = new Map();
  h.forEach((c,i)=>{
    const m = String(c).match(/^(\d{4}-\d{2})_(h|w)$/);
    if (!m) return;
    if (!map.has(m[1])) map.set(m[1], {ym:m[1],hCol:-1,wCol:-1});
    map.get(m[1])[m[2]==='h' ? 'hCol' : 'wCol'] = i;
  });
  return [...map.values()].filter(x=>x.hCol>=0 && x.wCol>=0);
}
function readActiveMasterIdSet_() {
  const sh = getSS_().getSheetByName(SHEET_MASTER);
  if(!sh) return new Set();
  const v = sh.getDataRange().getValues();
  const ci = v[0].indexOf('child_id'), si = v[0].indexOf('在園・卒園');
  const set = new Set();
  for (let i=1; i<v.length; i++) {
    const cid = normalizeId_(v[i][ci]);
    if (cid !== '0' && (si === -1 || v[i][si] !== '卒園')) set.add(cid);
  }
  return set;
}
