/************ 設定 ************/
const SHEET_MASTER = '園児マスター';
const SHEET_BELONGS = '所属_年度';
const SHEET_INPUT_PREFIX = '入力_月次';
const SHEET_LOG = 'ログ_縦持ち';

const WEBAPP_URL_PROP = 'WEBAPP_URL';
const LOG_UPDATED_AT_PROP = 'LOG_UPDATED_AT';

// 同一実行内キャッシュ用の変数
let _belongsCache = null;

/************ 身体発育曲線 基準データ（パーセンタイル値） ************/
// TODO: 令和5年度「乳幼児身体発育調査」データに差し替え予定
// 現在は平成22年度の公開データに基づくプレースホルダー値
// 配列インデックス = 月齢（0〜72）、単位: 身長=cm, 体重=kg
const GROWTH_REF = {
  male: {
    height: {
      p3:  [44.0,48.7,52.2,55.1,57.5,59.6,61.4,63.0,64.4,65.7,66.9,68.0,69.0,69.9,70.8,71.7,72.6,73.5,74.3,75.1,75.9,76.7,77.5,78.2,78.9,79.6,80.3,80.9,81.5,82.1,82.7,83.3,83.8,84.4,85.0,85.6,86.2,86.8,87.4,88.0,88.6,89.2,89.8,90.4,91.0,91.6,92.2,92.8,93.4,94.0,94.6,95.2,95.8,96.4,97.0,97.5,98.0,98.5,99.0,99.5,100.0,100.5,101.0,101.5,102.0,102.5,103.0,103.5,104.0,104.5,105.0,105.5,106.0],
      p50: [48.7,53.5,57.1,60.1,62.5,64.7,66.7,68.5,70.1,71.5,72.8,74.0,75.0,76.0,77.1,78.2,79.2,80.1,80.9,81.7,82.5,83.3,84.0,84.7,85.4,86.1,86.7,87.4,88.0,88.7,89.3,89.9,90.5,91.2,91.9,92.5,93.2,93.9,94.5,95.2,95.9,96.5,97.2,97.8,98.5,99.1,99.7,100.3,100.9,101.5,102.1,102.8,103.4,104.0,104.6,105.2,105.8,106.4,107.0,107.6,108.2,108.8,109.5,110.1,110.7,111.3,111.9,112.5,113.1,113.7,114.3,114.9,115.6],
      p97: [53.5,58.4,62.1,65.1,67.5,69.8,72.0,73.9,75.7,77.3,78.8,80.1,81.3,82.4,83.5,84.6,85.6,86.6,87.5,88.3,89.1,89.9,90.7,91.5,92.2,92.9,93.6,94.3,95.0,95.7,96.4,97.0,97.6,98.3,99.0,99.6,100.3,101.0,101.6,102.3,102.9,103.5,104.2,104.8,105.5,106.1,106.7,107.3,108.0,108.6,109.3,109.9,110.5,111.2,111.8,112.4,113.0,113.6,114.2,114.9,115.5,116.1,116.7,117.3,118.0,118.6,119.2,119.8,120.4,121.0,121.7,122.3,122.9]
    },
    weight: {
      p3:  [2.10,2.90,3.60,4.19,4.65,5.04,5.37,5.65,5.89,6.10,6.29,6.46,6.61,6.76,6.91,7.06,7.20,7.34,7.48,7.62,7.76,7.89,8.02,8.15,8.28,8.41,8.54,8.67,8.80,8.93,9.06,9.19,9.31,9.44,9.56,9.68,9.80,9.92,10.04,10.16,10.28,10.40,10.52,10.64,10.76,10.88,11.00,11.12,11.24,11.36,11.48,11.60,11.72,11.84,11.96,12.08,12.20,12.32,12.44,12.56,12.68,12.80,12.92,13.04,13.16,13.28,13.40,13.52,13.64,13.76,13.88,14.00,14.12],
      p50: [2.98,4.13,5.10,5.84,6.44,6.94,7.35,7.70,8.00,8.27,8.50,8.72,8.92,9.12,9.32,9.52,9.72,9.91,10.09,10.27,10.45,10.62,10.79,10.96,11.13,11.30,11.47,11.64,11.81,11.98,12.15,12.32,12.48,12.65,12.82,12.98,13.15,13.31,13.47,13.64,13.80,13.97,14.13,14.30,14.47,14.64,14.81,14.98,15.15,15.32,15.50,15.68,15.86,16.04,16.22,16.40,16.58,16.76,16.94,17.12,17.30,17.49,17.68,17.87,18.06,18.25,18.44,18.63,18.82,19.01,19.20,19.39,19.58],
      p97: [3.76,5.17,6.37,7.31,8.07,8.72,9.28,9.77,10.19,10.57,10.91,11.22,11.50,11.76,12.02,12.28,12.54,12.79,13.04,13.28,13.52,13.76,13.99,14.22,14.46,14.70,14.94,15.18,15.42,15.66,15.90,16.14,16.38,16.62,16.86,17.10,17.34,17.58,17.82,18.06,18.30,18.54,18.78,19.02,19.27,19.52,19.77,20.02,20.27,20.52,20.78,21.04,21.30,21.56,21.82,22.08,22.34,22.60,22.86,23.12,23.38,23.65,23.92,24.19,24.46,24.73,25.00,25.27,25.54,25.81,26.08,26.35,26.62]
    }
  },
  female: {
    height: {
      p3:  [44.0,48.1,51.4,54.2,56.5,58.5,60.2,61.7,63.1,64.3,65.4,66.4,67.4,68.4,69.3,70.2,71.1,71.9,72.7,73.5,74.3,75.0,75.7,76.4,77.1,77.8,78.4,79.0,79.6,80.2,80.8,81.3,81.8,82.4,83.0,83.5,84.1,84.7,85.3,85.9,86.5,87.0,87.6,88.1,88.7,89.2,89.8,90.3,90.9,91.4,92.0,92.5,93.1,93.6,94.2,94.7,95.2,95.7,96.2,96.7,97.2,97.7,98.2,98.7,99.2,99.7,100.2,100.7,101.2,101.7,102.2,102.7,103.2],
      p50: [48.3,52.7,56.0,58.8,61.0,63.0,65.0,66.7,68.3,69.7,71.0,72.2,73.4,74.5,75.6,76.6,77.5,78.4,79.2,80.0,80.8,81.5,82.2,82.9,83.6,84.3,84.9,85.6,86.2,86.8,87.4,88.0,88.6,89.2,89.8,90.4,91.0,91.6,92.2,92.8,93.4,94.0,94.6,95.2,95.8,96.4,97.0,97.6,98.2,98.8,99.4,100.0,100.6,101.2,101.8,102.4,103.0,103.6,104.2,104.8,105.4,106.0,106.6,107.2,107.8,108.4,109.0,109.6,110.2,110.8,111.4,112.0,112.6],
      p97: [52.7,57.4,60.8,63.7,66.0,68.1,70.0,71.8,73.4,74.9,76.2,77.4,78.6,79.7,80.8,81.9,82.9,83.9,84.8,85.7,86.6,87.4,88.2,89.0,89.7,90.5,91.2,91.9,92.6,93.3,94.0,94.7,95.4,96.1,96.8,97.4,98.1,98.8,99.4,100.0,100.6,101.2,101.8,102.4,103.0,103.6,104.2,104.8,105.4,106.0,106.6,107.2,107.8,108.4,109.0,109.6,110.2,110.8,111.4,112.0,112.6,113.2,113.8,114.4,115.0,115.6,116.2,116.8,117.4,118.0,118.6,119.2,119.8]
    },
    weight: {
      p3:  [2.13,2.79,3.44,3.98,4.41,4.78,5.09,5.35,5.58,5.78,5.96,6.12,6.27,6.41,6.55,6.69,6.83,6.97,7.10,7.23,7.36,7.49,7.62,7.74,7.86,7.98,8.10,8.22,8.34,8.46,8.58,8.70,8.82,8.93,9.05,9.16,9.27,9.38,9.49,9.60,9.71,9.82,9.93,10.04,10.15,10.26,10.37,10.48,10.59,10.70,10.81,10.92,11.03,11.14,11.25,11.36,11.47,11.58,11.69,11.80,11.91,12.02,12.13,12.24,12.35,12.46,12.57,12.68,12.79,12.90,13.01,13.12,13.23],
      p50: [2.91,3.89,4.72,5.40,5.97,6.44,6.83,7.17,7.46,7.72,7.95,8.17,8.37,8.57,8.76,8.95,9.14,9.33,9.51,9.68,9.86,10.03,10.20,10.36,10.52,10.68,10.84,11.00,11.16,11.32,11.48,11.64,11.80,11.95,12.10,12.25,12.40,12.55,12.70,12.85,13.00,13.16,13.32,13.48,13.64,13.80,13.96,14.12,14.28,14.44,14.60,14.77,14.94,15.11,15.28,15.45,15.62,15.79,15.96,16.13,16.30,16.47,16.64,16.81,16.98,17.15,17.32,17.49,17.66,17.83,18.00,18.17,18.34],
      p97: [3.67,4.93,6.06,6.95,7.68,8.30,8.83,9.29,9.70,10.06,10.39,10.69,10.97,11.24,11.50,11.76,12.02,12.27,12.52,12.76,13.00,13.24,13.47,13.70,13.93,14.16,14.39,14.62,14.85,15.08,15.31,15.54,15.77,16.00,16.23,16.46,16.69,16.92,17.15,17.38,17.61,17.84,18.07,18.30,18.54,18.78,19.02,19.26,19.50,19.74,19.98,20.22,20.46,20.70,20.94,21.18,21.42,21.66,21.90,22.14,22.38,22.62,22.86,23.10,23.34,23.58,23.82,24.06,24.30,24.54,24.78,25.02,25.26]
    }
  }
};

/************ Webアプリ（初期表示） ************/
function doGet(e) {
  const t = e?.parameter?.t;
  if (!t) return htmlMessage_('URLが正しくありません');

  const data = getChildData_(t, null);
  if (!data) return htmlMessage_('データが見つかりません');

  const tpl = HtmlService.createTemplateFromFile('viewer');
  tpl.token = t;
  tpl.initialDataJson = JSON.stringify(data);

  return tpl.evaluate()
    .setTitle('成長記録')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/************ データ切り替え・更新用関数 ************/
function getDataForFy(token, fy) {
  return getChildData_(token, fy ? Number(fy) : null);
}

/************ ① トークン発行＆URL作成 ************/
function ensureTokensAndUrls() {
  const ss = getSS_();
  const sh = ss.getSheetByName(SHEET_MASTER);
  if (!sh) throw new Error('園児マスターが見つかりません');

  let webappUrl = PropertiesService.getScriptProperties().getProperty(WEBAPP_URL_PROP);
  if (!webappUrl) {
    const u = ScriptApp.getService().getUrl();
    if (u) {
      webappUrl = u;
      PropertiesService.getScriptProperties().setProperty(WEBAPP_URL_PROP, webappUrl);
    }
  }

  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();
  if (lastRow < 2) return;

  const data = sh.getRange(1, 1, lastRow, lastCol).getValues();
  const header = data[0];
  const idxChild = mustIndex_(header, 'child_id');
  const idxToken = mustIndex_(header, 'token');
  const idxUrl   = mustIndex_(header, 'parent_url');
  const idxQr    = header.indexOf('QRコードURL');
  const idxStatus = header.indexOf('在園・卒園');

  let successCount = 0;
  for (let r = 1; r < data.length; r++) {
    const rowNum = r + 1;
    const cid = String(data[r][idxChild] || '').trim();
    if (!cid || (idxStatus !== -1 && data[r][idxStatus] === '卒園')) continue;

    const hasToken = !!String(data[r][idxToken] || '').trim();
    const hasUrl   = !!String(data[r][idxUrl] || '').trim();
    const hasQr    = (idxQr === -1) || !!String(data[r][idxQr] || '').trim();

    if (hasToken && hasUrl && hasQr) continue;

    let rowToken = data[r][idxToken] || generateToken(40);
    let rowUrl = `${webappUrl}?t=${encodeURIComponent(rowToken)}`;
    let rowQr = (idxQr !== -1) ? `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(rowUrl)}` : null;

    try {
      if (!hasToken) sh.getRange(rowNum, idxToken + 1).setValue(rowToken);
      sh.getRange(rowNum, idxUrl + 1).setValue(rowUrl);
      if (idxQr !== -1 && !hasQr) sh.getRange(rowNum, idxQr + 1).setValue(rowQr);
      successCount++;
    } catch(e) { console.log(e); }
  }
  SpreadsheetApp.getUi().alert(successCount === 0 ? '更新不要でした。' : successCount + ' 名更新しました。');
}

/************ ② 入力 → 縦持ちログ更新 ************/
function rebuildLogFromInput() {
  const ss = getSS_();
  const inputSheets = ss.getSheets().filter(s => s.getName().startsWith(SHEET_INPUT_PREFIX));
  const activeMasterIds = readActiveMasterIdSet_(); 
  const out = [];

  inputSheets.forEach(sh => {
    const values = sh.getDataRange().getValues();
    if (values.length < 2) return;
    const headerRowIndex = findHeaderRowIndex_(values);
    if (headerRowIndex < 0) return;
    const header = values[headerRowIndex];
    const idxChild = header.indexOf('child_id');
    const months = parseMonthColumns_(header);

    for (let r = headerRowIndex + 1; r < values.length; r++) {
      const cid = normalizeId_(values[r][idxChild]);
      if (!cid || !activeMasterIds.has(cid)) continue;
      months.forEach(m => {
        const h = toNumberOrBlank_(values[r][m.hCol]);
        const w = toNumberOrBlank_(values[r][m.wCol]);
        if ((h !== '' || w !== '') && !(h === 0 && w === 0)) {
          out.push([cid, String(m.ym), h, w]);
        }
      });
    }
  });

  out.sort((a, b) => {
    if (a[0] !== b[0]) return a[0].localeCompare(b[0], undefined, {numeric: true});
    return a[1].localeCompare(b[1]);
  });

  let logSh = ss.getSheetByName(SHEET_LOG);
  if (!logSh) logSh = ss.insertSheet(SHEET_LOG);
  logSh.clearContents();
  const finalOut = [['child_id','ym','height','weight'], ...out];
  logSh.getRange(1, 1, finalOut.length, finalOut[0].length).setValues(finalOut);
  if (finalOut.length > 1) logSh.getRange(2, 2, finalOut.length - 1, 1).setNumberFormat('@');

  PropertiesService.getScriptProperties().setProperty(LOG_UPDATED_AT_PROP, new Date().toISOString());
  SpreadsheetApp.getUi().alert('縦持ちログを更新しました。');
}

/************ 高速データ取得ロジック（ChatGPT改善反映版） ************/
function getChildData_(token, targetFy) {
  const ss = getSS_();
  const masterSh = ss.getSheetByName(SHEET_MASTER);
  const logSh = ss.getSheetByName(SHEET_LOG);
  const belongsSh = ss.getSheetByName(SHEET_BELONGS);
  if (!masterSh || !logSh) return null;

  const masterValues = masterSh.getDataRange().getValues();
  const m = masterFindByToken_(masterValues, token);
  if (!m) return null;

  const targetCid = normalizeId_(m.child_id);
  const seriesAll = [];

  const lastRowLog = logSh.getLastRow();
  let firstMatch = null;
  if (lastRowLog > 1) {
    firstMatch = logSh.getRange(2, 1, lastRowLog - 1, 1)
      .createTextFinder(targetCid)
      .matchEntireCell(true)
      .findNext();
  }

  if (firstMatch) {
    const startRow = firstMatch.getRow();
    const MAX_ROWS_PER_CHILD = 120;
    const rowsToRead = Math.min(MAX_ROWS_PER_CHILD, (lastRowLog - startRow + 1));
    const numCols = 4;

    const data = logSh.getRange(startRow, 1, rowsToRead, numCols).getValues();
    
    for (let row of data) {
      if (normalizeId_(row[0]) !== targetCid) break;
      const ym = ymToYYYYMM_(row[1]);
      if (/^\d{4}-\d{2}$/.test(ym)) {
        seriesAll.push({ ym, h: toNumberOrNull_(row[2]), w: toNumberOrNull_(row[3]) });
      }
    }
  }
  seriesAll.sort((a,b) => a.ym.localeCompare(b.ym));

  const fyOfYm = (ymStr) => {
    const [y,m] = String(ymStr).split('-').map(Number);
    return (m >= 4) ? y : (y - 1);
  };

  const fySet = new Set(seriesAll.map(r => fyOfYm(r.ym)));
  const fyList = Array.from(fySet).sort((a,b)=>a-b);
  const selectedFy = (targetFy && fySet.has(targetFy)) ? targetFy : (fyList.length ? fyList[fyList.length - 1] : null);

  let displayClass = "クラス不明";
  if (belongsSh && selectedFy) {
    // ★改善：同一実行内キャッシュを利用して読み込みを効率化
    const bVals = getBelongsValues_(belongsSh);
    const head = bVals[0];
    const ci = head.indexOf('child_id'), fi = head.indexOf('fy'), ni = head.indexOf('class');
    const match = bVals.find(r => normalizeId_(r[ci]) === targetCid && Number(r[fi]) === selectedFy);
    if (match) displayClass = match[ni];
  }

  const series = (selectedFy == null) ? [] : seriesAll.filter(r => fyOfYm(r.ym) === selectedFy);

  // 身体発育曲線データを付加（birthday・gender が有効な場合のみ）
  if (m.birthday && m.gender) {
    series.forEach(entry => {
      const age = calcMonthAge_(m.birthday, entry.ym);
      entry.monthAge = age;
      const hRef = lookupPercentile_(m.gender, 'height', age);
      if (hRef) { entry.p3_h = hRef.p3; entry.p50_h = hRef.p50; entry.p97_h = hRef.p97; }
      const wRef = lookupPercentile_(m.gender, 'weight', age);
      if (wRef) { entry.p3_w = wRef.p3; entry.p50_w = wRef.p50; entry.p97_w = wRef.p97; }
    });
  }

  const latest = series.length ? series[series.length - 1] : null;
  const prev = series.length > 1 ? series[series.length - 2] : null;

  // ★改善：!= null 判定により、値が 0 の場合でも正しく計算されるように修正
  const diff = {
    dh: (latest?.h != null && prev?.h != null) ? +(latest.h - prev.h).toFixed(1) : null,
    dw: (latest?.w != null && prev?.w != null) ? +(latest.w - prev.w).toFixed(1) : null
  };

  const iso = PropertiesService.getScriptProperties().getProperty(LOG_UPDATED_AT_PROP);
  const updatedAt = iso ? Utilities.formatDate(new Date(iso), 'JST', 'yyyy/MM/dd HH:mm') : '—';

  return {
    childName: m.name,
    childClass: displayClass,
    gender: m.gender || null,
    series: series,
    latest: latest,
    diff: diff,
    updatedAt: updatedAt,
    fyList: fyList,
    selectedFy: selectedFy,
    siblings: m.siblings,
    appUrl: ScriptApp.getService().getUrl()
  };
}

/** 所属シートの読み込みをキャッシュ化するヘルパー */
function getBelongsValues_(belongsSh) {
  if (_belongsCache) return _belongsCache;
  _belongsCache = belongsSh.getDataRange().getValues();
  return _belongsCache;
}

/************ 共通ヘルパー ************/
function masterFindByToken_(values, token) {
  const head = values[0];
  const ci = head.indexOf('child_id'), ni = head.indexOf('name'), ti = head.indexOf('token');
  const bi = head.indexOf('birthday'), gi = head.indexOf('gender');
  for (let i=1; i<values.length; i++) {
    if (values[i][ti] === token) {
      const sibs = [];
      if (values[i][7]) sibs.push({ name: String(values[i][6] || '兄弟1'), token: String(values[i][7]) });
      if (values[i][9]) sibs.push({ name: String(values[i][8] || '兄弟2'), token: String(values[i][9]) });

      let birthday = null;
      if (bi !== -1 && values[i][bi]) {
        const bv = values[i][bi];
        if (bv instanceof Date) {
          birthday = `${bv.getFullYear()}-${String(bv.getMonth()+1).padStart(2,'0')}-${String(bv.getDate()).padStart(2,'0')}`;
        } else {
          const s = String(bv).trim();
          if (/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/.test(s)) birthday = s.replace(/\//g, '-');
        }
      }

      let gender = null;
      if (gi !== -1) {
        const gv = String(values[i][gi] || '').trim();
        if (gv === '男') gender = 'male';
        else if (gv === '女') gender = 'female';
      }

      return {
        child_id: normalizeId_(values[i][ci]),
        name: String(values[i][ni] || '').replace(/[\s\u200B-\u200D\uFEFF]+/g,''),
        siblings: sibs,
        birthday: birthday,
        gender: gender
      };
    }
  }
  return null;
}

/** 月齢計算: 生年月日("YYYY-MM-DD")と測定月("YYYY-MM")から月齢を返す */
function calcMonthAge_(birthdayStr, ym) {
  const [by, bm] = birthdayStr.split('-').map(Number);
  const [y, m] = ym.split('-').map(Number);
  return (y - by) * 12 + (m - bm);
}

/** パーセンタイル値検索: 性別・指標・月齢から {p3, p50, p97} を返す（範囲外はnull） */
function lookupPercentile_(gender, metric, monthAge) {
  if (monthAge < 0 || monthAge > 72) return null;
  const ref = GROWTH_REF[gender]?.[metric];
  if (!ref || monthAge >= ref.p50.length) return null;
  return { p3: ref.p3[monthAge], p50: ref.p50[monthAge], p97: ref.p97[monthAge] };
}

function getSS_() { return SpreadsheetApp.getActiveSpreadsheet(); }
function normalizeId_(v) { return String(v || '').trim().replace(/^0+/, '') || '0'; }
function ymToYYYYMM_(v) {
  if (v instanceof Date) return `${v.getFullYear()}-${String(v.getMonth() + 1).padStart(2, '0')}`;
  const s = String(v).trim();
  const m = s.match(/^(\d{4})-(\d{1,2})$/);
  return m ? `${m[1]}-${m[2].padStart(2,'0')}` : s;
}
function mustIndex_(h, n){ const i = h.indexOf(n); if (i < 0) throw new Error(`「${n}」列なし`); return i; }
function generateToken(l){ const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; return [...Array(l)].map(()=>c[Math.floor(Math.random()*c.length)]).join(''); }
function toNumberOrNull_(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }
function toNumberOrBlank_(v){ const n = Number(v); return Number.isFinite(n) ? n : ''; }
function htmlMessage_(m){ return HtmlService.createHtmlOutput(`<meta name="viewport" content="width=device-width, initial-scale=1"><div style="padding:16px">${m}</div>`); }
function findHeaderRowIndex_(v) {
  for (let i = 0; i < Math.min(v.length, 20); i++) if (v[i].includes('child_id')) return i;
  return -1;
}
function parseMonthColumns_(h) {
  const map = new Map();
  h.forEach((c,i)=>{
    const m = String(c).match(/^(\d{4}-\d{2})_(h|w)$/);
    if (!m) return;
    if (!map.has(m[1])) map.set(m[1], {ym:m[1],hCol:-1,wCol:-1});
    map.get(m[1])[m[2]==='h' ? 'hCol' : 'wCol'] = i;
  });
  return [...map.values()].filter(x=>x.hCol>=0 && x.wCol>=0);
}
function readActiveMasterIdSet_() {
  const sh = getSS_().getSheetByName(SHEET_MASTER);
  if(!sh) return new Set();
  const v = sh.getDataRange().getValues();
  const ci = v[0].indexOf('child_id'), si = v[0].indexOf('在園・卒園');
  const set = new Set();
  for (let i=1; i<v.length; i++) {
    const cid = normalizeId_(v[i][ci]);
    if (cid !== '0' && (si === -1 || v[i][si] !== '卒園')) set.add(cid);
  }
  return set;
}
